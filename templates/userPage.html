{% extends "header.html" %}
{% block title %} {user.name} {% endblock %}

{% block content %}

<div class="containerForAcc">
    <p>{{user.name}}</p>
    <p>{{user.login}}</p>



    <table>
        <tr>
            <th>User Name</th>
            <th></th>
            <th>User Lunch</th>
            <th>Time</th>
        </tr>
            {% for el in orders %}
        <tr>
            <td>{{ el.get_user_name_by_id() }}</td>
            <td></td>
            <td>{{ el.get_lunch_by_id().id}}</td>
            <td> {{ el.date.strftime("%H:%M")}}</td>
            <td></td>
        </tr>
        {% endfor%}
    </table>
    <div>
        <a href="/logout">LogOut</a>
    </div>

    <section class="chart">
      <h1 class="chart__title">By likes: </h1>

      <form class="chart__data" action="#" method="POST">
        {% for lunch in lunches %}
           <div class="chart__input-group invisible">
          <label class="chart__label invisible" for="{{lunch.id}}">{{ lunch.id}} </label>
          <input class="chart__input input-field invisible" type="number" name="{{lunch.id}}" id="{{lunch.id}}" min="0" max="100"
                 required value = {{lunch.likes_amount}}>
            </div>
          {% endfor %}
        <input class="chart__submit-button input-field" type="submit" value="Show">
      </form>

      <div class="chart__canvas-wrapper invisible">
        <canvas id="canvas" width="600px" height="250px">Браузер не поддерживает Canvas</canvas>
      </div>
    </section>

    <script>

        const MAX_PERCENTAGE = 100;
        const formElement = document.querySelector(`.chart__data`);
        const inputElements = formElement.querySelectorAll(`.chart__input`);
        const COLORS = [
          `#b3d5fc`,
          `#8E8D8A`,
          `#e98074`
        ];

        const BarSize = {
          MAX_HEIGHT: 200,
          WIDTH: 10
        };

        const BarCoordinate = {
          INITIAL_X: 40,
          INITIAL_Y: 200
        }

        const Font = {
          SIZE: `16px`,
          FAMILY: `Tahoma`
        };

        const LabelCoordinate = {
          INITIAL_X: 10,
          INITIAL_Y: 50
        }

        const Gap = {
          HORIZONTAL: 20,
          VERTICAL: 20
        }

        const getData = (inputElements) => {
          return Array.from(inputElements).map((input, index) => ({
            name: input.name,
            value: input.value,
            color: COLORS[index%3]
          }));
        };


        const canvas = document.querySelector(`#canvas`);
        const ctx = canvas.getContext(`2d`);

        const renderChart = (items) => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          let currentLabelY = LabelCoordinate.INITIAL_Y;
          let currentBarX = BarCoordinate.INITIAL_X;
          const gapBetweenBars = BarSize.WIDTH + Gap.HORIZONTAL;

          for (const item of items) {
            const barHeight = (item.value * BarSize.MAX_HEIGHT) / MAX_PERCENTAGE;
            console.log(barHeight);
            ctx.fillStyle = item.color;
            ctx.font = `${Font.SIZE} ${Font.FAMILY}`;
            ctx.save();
            ctx.translate(0, canvas.height);
            ctx.rotate(-Math.PI/2);
            ctx.fillText(item.name.toUpperCase(), LabelCoordinate.INITIAL_X, currentLabelY);
            ctx.restore();
            ctx.fillRect(currentBarX, BarCoordinate.INITIAL_Y, BarSize.WIDTH, -barHeight);

            currentBarX += gapBetweenBars;
            currentLabelY += gapBetweenBars;
          }
        };
        var el = document.querySelector('.chart__canvas-wrapper');
        formElement.addEventListener(`submit`, (evt) => {
          evt.preventDefault();
          renderChart(getData(inputElements));
          formElement.reset();
          el.classList.toggle('invisible');
        });

    </script>


</div>


{% endblock %}